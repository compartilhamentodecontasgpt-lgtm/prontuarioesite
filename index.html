<!--
BTX Clinic ‚Äî single-file HTML (100% offline) | Dr. Orlando Abreu Gomes da Silva
Como usar:
1) Salve como: index.html
2) Abra no navegador (Chrome/Edge).
3) Na tela inicial, clique na foto para adicionar sua foto (fica salva no aparelho).
4) Login fica no canto inferior direito. Senha padr√£o: btx1234
5) Tudo salva offline (localStorage). Tem Backup/Restaurar no menu.

Obs.: √â um ‚Äúsoftware inteiro‚Äù em um arquivo s√≥ (HTML+CSS+JS). Depois a gente empacota como PWA se voc√™ quiser.
-->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BTX Clinic ‚Äî Dr. Orlando Abreu Gomes da Silva</title>

  <style>
    :root{
      --bg0:#070a0f;
      --bg1:#0b1220;
      --bg2:#0f172a;
      --card:#0b1020;
      --card2:#0a1426;
      --line:rgba(150,180,255,.12);
      --line2:rgba(150,180,255,.18);
      --text:#e6eefc;
      --muted:rgba(230,238,252,.68);
      --muted2:rgba(230,238,252,.48);
      --accent:#18f7a8;   /* verde tecnol√≥gico */
      --accent2:#00d7ff;  /* ciano sutil */
      --warn:#ffcc66;
      --bad:#ff5c7a;
      --ok:#18f7a8;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(24,247,168,.12), transparent 55%),
        radial-gradient(1000px 650px at 85% 20%, rgba(0,215,255,.12), transparent 50%),
        linear-gradient(145deg, var(--bg0), var(--bg1) 35%, var(--bg2));
      overflow-x:hidden;
    }

    /* ====== micro UI ====== */
    .glass{
      background: linear-gradient(145deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--line2);
      background: linear-gradient(145deg, rgba(24,247,168,.12), rgba(0,215,255,.06));
      color:var(--text);
      padding:10px 14px;
      border-radius:14px;
      transition: transform .08s ease, border-color .15s ease, filter .15s ease;
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(24,247,168,.45); filter:brightness(1.05); }
    .btn:active{ transform: translateY(1px); }
    .btn.ghost{
      background: rgba(255,255,255,.03);
    }
    .btn.danger{
      background: linear-gradient(145deg, rgba(255,92,122,.18), rgba(255,92,122,.08));
      border-color: rgba(255,92,122,.25);
    }
    .btn.ok{
      background: linear-gradient(145deg, rgba(24,247,168,.18), rgba(24,247,168,.08));
      border-color: rgba(24,247,168,.25);
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(24,247,168,.6);
    }
    .kpi{
      display:flex; gap:14px; flex-wrap:wrap;
      margin-top:12px;
    }
    .kpi .box{
      min-width: 180px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .kpi .n{
      font-family:var(--mono);
      font-size:20px;
      color:var(--accent);
      text-shadow: 0 0 22px rgba(24,247,168,.35);
    }
    .kpi .l{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }

    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(24,247,168,.55);
      box-shadow: 0 0 0 4px rgba(24,247,168,.10);
    }

    .grid{ display:grid; gap:14px; }
    .grid.two{ grid-template-columns: 1fr 1fr; }
    .grid.three{ grid-template-columns: 1fr 1fr 1fr; }
    @media (max-width: 980px){
      .grid.two, .grid.three{ grid-template-columns: 1fr; }
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:18px;
      background: rgba(255,255,255,.02);
    }
    .table th, .table td{
      padding:10px 12px;
      border-bottom:1px solid rgba(150,180,255,.10);
      font-size:13px;
      color:var(--muted);
      text-align:left;
      vertical-align:top;
    }
    .table th{ color:rgba(230,238,252,.78); background: rgba(255,255,255,.02); }
    .table tr:last-child td{ border-bottom:none; }
    .table td strong{ color:var(--text); }

    /* ====== Landing / login ====== */
    .landing{
      min-height:100vh;
      display:grid;
      grid-template-columns: 1.25fr .9fr;
      gap:22px;
      padding:22px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .landing{ grid-template-columns:1fr; padding:16px; }
    }
    .hero{
      border-radius: var(--radius2);
      padding:20px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(420px 220px at 20% 10%, rgba(24,247,168,.22), transparent 60%),
        radial-gradient(380px 240px at 90% 30%, rgba(0,215,255,.18), transparent 60%),
        linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      z-index:0;
      filter: saturate(1.2);
    }
    .hero > *{ position:relative; z-index:1; }

    .brandRow{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:16px;
    }
    .brand{
      display:flex; gap:12px; align-items:center;
    }
    .logoMark{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(24,247,168,.35);
      background: radial-gradient(circle at 30% 30%, rgba(24,247,168,.35), rgba(0,0,0,.1) 55%),
                  linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 0 30px rgba(24,247,168,.15);
      display:grid; place-items:center;
      font-family:var(--mono);
      color:var(--accent);
      font-weight:800;
      letter-spacing:.5px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.3px;
      font-weight:700;
    }
    .brand small{
      display:block;
      margin-top:2px;
      color:var(--muted);
      font-size:12px;
    }

    .profileCard{
      margin-top:12px;
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 620px){
      .profileCard{ grid-template-columns: 1fr; }
    }

    .proPhoto{
      border-radius:22px;
      border:1px dashed rgba(24,247,168,.35);
      background: rgba(0,0,0,.25);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      min-height:180px;
      display:grid; place-items:center;
    }
    .proPhoto img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }
    .proPhoto .hint{
      position:absolute; inset:auto 10px 10px 10px;
      padding:10px 10px;
      border-radius:16px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(150,180,255,.12);
      color:rgba(230,238,252,.8);
      font-size:12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .proPhoto .hint span{ color:var(--accent); font-family:var(--mono); font-weight:700; }

    .bio{
      border-radius:22px;
      padding:16px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.20);
    }
    .bio h2{
      margin:0 0 6px 0;
      font-size:20px;
      color:var(--text);
      letter-spacing:.2px;
    }
    .bio .tagline{
      margin:0 0 10px 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .bio ul{
      margin:10px 0 0 0;
      padding-left: 18px;
      color:rgba(230,238,252,.72);
      font-size:13px;
      line-height:1.5;
    }
    .bio li{ margin:4px 0; }
    .accentLine{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(24,247,168,.55), rgba(0,215,255,.25), transparent);
      margin:12px 0;
    }

    .landingRight{
      border-radius: var(--radius2);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .landingRight .panelTitle{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:10px;
    }
    .panelTitle h3{
      margin:0;
      font-size:14px;
      letter-spacing:.6px;
      color:rgba(230,238,252,.85);
      text-transform:uppercase;
    }

    /* login corner bottom */
    .loginCorner{
      position:absolute;
      right:16px;
      bottom:16px;
      width:min(420px, calc(100% - 32px));
      border-radius: 22px;
      padding:14px;
      border:1px solid rgba(150,180,255,.14);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .loginCorner .row{
      display:flex; gap:10px; align-items:center;
    }
    .loginCorner .row input{ flex:1; }
    .loginCorner .mini{
      margin-top:8px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color:var(--muted2);
      font-size:12px;
    }
    .loginCorner .mini code{ font-family:var(--mono); color:var(--accent); }

    /* ====== App shell ====== */
    .app{
      display:none;
      min-height:100vh;
      padding:16px;
    }
    .shell{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      min-height: calc(100vh - 32px);
    }
    @media (max-width: 980px){
      .shell{ grid-template-columns: 1fr; }
      .sidebar{ position:sticky; top:12px; z-index:5; }
    }

    .sidebar{
      border-radius: var(--radius2);
      padding:14px;
      overflow:hidden;
      position:relative;
    }
    .sidebar:before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(320px 220px at 40% 0%, rgba(24,247,168,.18), transparent 65%),
                  radial-gradient(360px 260px at 90% 30%, rgba(0,215,255,.12), transparent 70%);
      z-index:0;
    }
    .sidebar > *{ position:relative; z-index:1; }

    .sideProfile{
      display:flex; gap:12px; align-items:center;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.25);
      margin-bottom:12px;
    }
    .avatar{
      width:46px; height:46px; border-radius:16px;
      border:1px solid rgba(24,247,168,.35);
      background: rgba(255,255,255,.04);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .sideProfile .who{
      min-width:0;
    }
    .sideProfile .who strong{
      display:block;
      font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .sideProfile .who span{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }

    .nav{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      justify-content:flex-start;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(255,255,255,.03);
      border:1px solid rgba(150,180,255,.10);
      color:rgba(230,238,252,.85);
      cursor:pointer;
      transition: border-color .15s ease, background .15s ease;
    }
    .nav button:hover{ border-color: rgba(24,247,168,.35); }
    .nav button.active{
      background: linear-gradient(145deg, rgba(24,247,168,.16), rgba(0,215,255,.06));
      border-color: rgba(24,247,168,.45);
      color:var(--text);
    }

    .content{
      border-radius: var(--radius2);
      padding:16px;
      overflow:hidden;
    }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .topbar .left{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .topbar h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .topbar .right{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .panel{
      border-radius: 22px;
      padding:14px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.18);
    }
    .panel h3{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:rgba(230,238,252,.85);
    }

    .split{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:14px;
    }
    @media (max-width: 1100px){
      .split{ grid-template-columns: 1fr; }
    }

    /* ====== Odontograma ====== */
    .odoWrap{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .odoWrap{ grid-template-columns: 1fr; }
    }
    .teeth{
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){
      .teeth{ grid-template-columns: repeat(4, 1fr); }
    }
    .tooth{
      border-radius:18px;
      padding:10px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition: border-color .15s ease, transform .08s ease;
      user-select:none;
    }
    .tooth:hover{ border-color: rgba(24,247,168,.35); }
    .tooth:active{ transform: translateY(1px); }
    .tooth .id{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(230,238,252,.75);
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .miniGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:6px;
    }
    .surf{
      height:18px;
      border-radius:8px;
      border:1px solid rgba(150,180,255,.12);
      background: rgba(0,0,0,.20);
      display:grid; place-items:center;
      font-size:10px;
      color:rgba(230,238,252,.6);
    }
    .surf.ok{ background: rgba(24,247,168,.14); border-color: rgba(24,247,168,.30); color: rgba(230,238,252,.9); }
    .surf.bad{ background: rgba(255,92,122,.14); border-color: rgba(255,92,122,.30); color: rgba(230,238,252,.9); }
    .surf.warn{ background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.28); color: rgba(230,238,252,.9); }

    /* ====== Print doc (A4) ====== */
    .printPreviewHint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }

    /* ====== Tiny toast ====== */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform: translateX(-50%);
      padding:10px 14px;
      border-radius: 999px;
      border:1px solid rgba(150,180,255,.18);
      background: rgba(0,0,0,.55);
      color:rgba(230,238,252,.9);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      z-index:9999;
      font-size:13px;
    }
    .toast strong{ color: var(--accent); font-family:var(--mono); }

    /* ====== Utility ====== */
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .sp{ height:10px; }
    .hr{
      height:1px;
      background: rgba(150,180,255,.10);
      margin:12px 0;
    }

    /* ====== modal ====== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:9998;
    }
    .modal{
      width:min(980px, 100%);
      border-radius: 26px;
      border:1px solid rgba(150,180,255,.18);
      background: rgba(10,14,25,.85);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 14px 10px 14px;
      border-bottom:1px solid rgba(150,180,255,.12);
    }
    .modalHeader h3{
      margin:0;
      font-size:14px;
      letter-spacing:.5px;
      text-transform:uppercase;
      color:rgba(230,238,252,.85);
    }
    .modalBody{ padding:14px; }
  </style>
</head>

<body>

  <!-- ===== LANDING ===== -->
  <section id="landing" class="landing">
    <div class="hero glass">
      <div class="brandRow">
        <div class="brand">
          <div class="logoMark">BTX</div>
          <div>
            <h1>BTX Clinic</h1>
            <small>Software cl√≠nico offline ‚Ä¢ agenda ‚Ä¢ prontu√°rio ‚Ä¢ odontograma ‚Ä¢ documentos A4</small>
          </div>
        </div>
        <div class="pill"><span class="dot"></span> <span>Modo offline ‚Ä¢ mem√≥ria local</span></div>
      </div>

      <div class="profileCard">
        <div class="proPhoto" id="proPhotoBox" title="Clique para adicionar/alterar a foto do profissional">
          <div style="text-align:center; padding:18px;">
            <div style="font-size:44px; line-height:1;">üë®‚Äç‚öïÔ∏è</div>
            <div class="muted" style="margin-top:6px; font-size:12px;">Foto do profissional</div>
          </div>
          <div class="hint">
            <div>Toque para adicionar/alterar</div>
            <span>FICA SALVO</span>
          </div>
          <input id="proPhotoInput" type="file" accept="image/*" hidden />
        </div>

        <div class="bio">
          <h2>Dr. Orlando Abreu Gomes da Silva</h2>
          <p class="tagline">
            Dentista ‚Ä¢ Cirurgia e Traumatologia Buco-Maxilo-Facial ‚Ä¢ Sa√∫de Coletiva ‚Ä¢ Tecnologia aplicada √† sa√∫de
          </p>

          <div class="accentLine"></div>

          <ul>
            <li><strong>Graduado em Odontologia</strong> (2010)</li>
            <li><strong>P√≥s-graduado</strong> em Cirurgia Buco-Maxilo-Facial (2016)</li>
            <li><strong>P√≥s-graduado</strong> em Sa√∫de Coletiva</li>
            <li><strong>P√≥s-graduando</strong> em Patologia</li>
            <li><strong>Graduando</strong> em Medicina</li>
            <li><strong>Graduando</strong> em Engenharia da Computa√ß√£o e An√°lise de Sistemas</li>
          </ul>

          <div class="hr"></div>

          <div class="row">
            <span class="pill"><span class="dot"></span> Destaque profissional</span>
            <span class="pill">Fundador da <strong style="color:var(--accent);">BTX Tech</strong> ‚Äî startup de biotecnologia</span>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="n" id="kpiPatients">0</div>
              <div class="l">pacientes cadastrados</div>
            </div>
            <div class="box">
              <div class="n" id="kpiToday">0</div>
              <div class="l">agendamentos hoje</div>
            </div>
            <div class="box">
              <div class="n" id="kpiMonth">0</div>
              <div class="l">agendamentos no m√™s</div>
            </div>
          </div>

          <div class="printPreviewHint">
            Dica: tudo aqui √© offline. Para trocar de aparelho: use <strong>Backup</strong> no menu.
          </div>
        </div>
      </div>
    </div>

    <div class="landingRight glass">
      <div class="panelTitle">
        <h3>Vis√£o do Sistema</h3>
        <span class="pill">Grafite + Verde tech</span>
      </div>

      <div class="panel">
        <h3>O que j√° vem pronto</h3>
        <div class="grid two">
          <div class="pill">üìÖ Agenda com contagem por dia</div>
          <div class="pill">üë§ Pacientes + ficha cl√≠nica (atualiza sempre)</div>
          <div class="pill">ü¶∑ Odontograma simples e funcional</div>
          <div class="pill">üßæ Receita / atestado / or√ßamento (A4)</div>
        </div>
        <div class="hr"></div>
        <div class="muted" style="font-size:13px; line-height:1.5;">
          <strong style="color:var(--accent);">Receita inteligente:</strong> voc√™ cadastra o paciente uma vez, depois s√≥
          seleciona o nome e o documento preenche (dados + modelos r√°pidos).  
          <br><br>
          <strong style="color:var(--accent);">Impress√£o sem quebrar feio:</strong> documento com moldura A4 e bordas
          ‚Äúinquebr√°veis‚Äù (quebra de p√°gina controlada).
        </div>
      </div>

      <!-- Login bottom-right -->
      <div class="loginCorner">
        <div class="row">
          <input id="loginPass" type="password" placeholder="Senha do sistema" autocomplete="current-password" />
          <button class="btn ok" id="btnLogin">Entrar</button>
        </div>
        <div class="mini">
          <div>Dica: senha padr√£o <code>btx1234</code></div>
          <button class="btn ghost" id="btnResetAll" title="Apaga tudo do dispositivo (pacientes, agenda, etc.)">Reset</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== APP ===== -->
  <section id="app" class="app">
    <div class="shell">
      <aside class="sidebar glass">
        <div class="sideProfile">
          <div class="avatar" id="sideAvatar">BTX</div>
          <div class="who">
            <strong id="proNameSide">Dr. Orlando Abreu Gomes da Silva</strong>
            <span class="muted">BTX Clinic ‚Ä¢ Offline-first</span>
          </div>
        </div>

        <div class="nav">
          <button class="active" data-view="dash">‚ö° Dashboard</button>
          <button data-view="agenda">üìÖ Agenda</button>
          <button data-view="patients">üë§ Pacientes / Ficha</button>
          <button data-view="odontogram">ü¶∑ Odontograma</button>
          <button data-view="docs">üßæ Documentos (A4)</button>
          <button data-view="backup">üíæ Backup</button>
          <button data-view="settings">‚öôÔ∏è Configura√ß√µes</button>
          <button id="btnLogout" class="danger">‚éã Sair</button>
        </div>

        <div class="hr"></div>
        <div class="muted2" style="font-size:12px; line-height:1.5;">
          <strong style="color:var(--accent);">Mem√≥ria:</strong> localStorage.  
          <strong style="color:var(--accent);">Backup:</strong> exporta JSON.
        </div>
      </aside>

      <main class="content glass">
        <div class="topbar">
          <div class="left">
            <h2 id="viewTitle">Dashboard</h2>
            <span class="pill"><span class="dot"></span> <span id="todayLabel"></span></span>
          </div>
          <div class="right">
            <button class="btn ghost" id="quickNewAppt">+ Agendar</button>
            <button class="btn ghost" id="quickNewPatient">+ Paciente</button>
          </div>
        </div>

        <!-- Views -->
        <div id="view_dash" class="view">
          <div class="split">
            <div class="panel">
              <h3>Resumo do Dia</h3>
              <div class="kpi">
                <div class="box">
                  <div class="n" id="dashTodayCount">0</div>
                  <div class="l">agendamentos hoje</div>
                </div>
                <div class="box">
                  <div class="n" id="dashWeekCount">0</div>
                  <div class="l">agendamentos 7 dias</div>
                </div>
                <div class="box">
                  <div class="n" id="dashPatients">0</div>
                  <div class="l">pacientes totais</div>
                </div>
              </div>

              <div class="hr"></div>

              <div class="field">
                <label>Buscar paciente ou agendamento</label>
                <input id="globalSearch" placeholder="Digite nome, telefone ou procedimento..." />
              </div>

              <div class="sp"></div>
              <div id="globalResults" class="muted" style="font-size:13px;"></div>
            </div>

            <div class="panel">
              <h3>Pr√≥ximos agendamentos</h3>
              <div id="nextAppts" class="muted" style="font-size:13px; line-height:1.5;"></div>
              <div class="hr"></div>
              <div class="muted2" style="font-size:12px;">
                Status: <span class="pill">üü¢ confirmado</span> <span class="pill">üü° pendente</span> <span class="pill">üî¥ faltou</span>
              </div>
            </div>
          </div>
        </div>

        <div id="view_agenda" class="view" style="display:none;">
          <div class="panel">
            <h3>Agenda</h3>

            <div class="grid three">
              <div class="field">
                <label>Dia</label>
                <input id="agendaDate" type="date" />
              </div>
              <div class="field">
                <label>Resumo do dia</label>
                <input id="agendaSummary" disabled />
              </div>
              <div class="row" style="align-self:end;">
                <button class="btn ok" id="btnNewAppt">+ Novo agendamento</button>
                <button class="btn ghost" id="btnToday">Hoje</button>
              </div>
            </div>

            <div class="hr"></div>

            <table class="table" id="agendaTable">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Paciente</th>
                  <th>Procedimento</th>
                  <th>Status</th>
                  <th style="width:180px;">A√ß√µes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>

            <div class="printPreviewHint">
              Dica: clique em <strong>Editar</strong> para mudar status e dados. Tudo salva autom√°tico.
            </div>
          </div>
        </div>

        <div id="view_patients" class="view" style="display:none;">
          <div class="split">
            <div class="panel">
              <h3>Pacientes</h3>
              <div class="grid two">
                <div class="field">
                  <label>Busca</label>
                  <input id="patientSearch" placeholder="Nome, telefone..." />
                </div>
                <div class="row" style="align-self:end; justify-content:flex-end;">
                  <button class="btn ok" id="btnNewPatient">+ Novo paciente</button>
                </div>
              </div>

              <div class="hr"></div>
              <div id="patientList" class="muted" style="font-size:13px;"></div>
            </div>

            <div class="panel">
              <h3>Ficha cl√≠nica</h3>
              <div id="patientEditorEmpty" class="muted" style="font-size:13px;">
                Selecione um paciente para ver/editar ficha.
              </div>

              <div id="patientEditor" style="display:none;">
                <div class="grid two">
                  <div class="field">
                    <label>Nome</label>
                    <input id="p_name" />
                  </div>
                  <div class="field">
                    <label>Telefone</label>
                    <input id="p_phone" placeholder="(91) 99999-9999" />
                  </div>
                  <div class="field">
                    <label>Data de nascimento</label>
                    <input id="p_dob" type="date" />
                  </div>
                  <div class="field">
                    <label>Observa√ß√µes r√°pidas</label>
                    <input id="p_tags" placeholder="Ex.: ansioso, HAS, alergia a dipirona..." />
                  </div>
                </div>

                <div class="sp"></div>

                <div class="field">
                  <label>Anamnese / evolu√ß√£o (atualiza sempre)</label>
                  <textarea id="p_notes" placeholder="Escreva aqui a evolu√ß√£o..."></textarea>
                </div>

                <div class="sp"></div>

                <div class="grid two">
                  <div class="field">
                    <label>Anexo (foto/arquivo) ‚Äî opcional</label>
                    <input id="p_file" type="file" />
                    <div class="muted2" style="font-size:12px; line-height:1.4;">
                      Salva offline (pode aumentar o tamanho do armazenamento dependendo do aparelho).
                    </div>
                  </div>
                  <div class="panel" style="padding:12px;">
                    <h3 style="margin-bottom:6px;">Preview anexo</h3>
                    <div id="p_filePreview" class="muted" style="font-size:13px;">Nenhum</div>
                  </div>
                </div>

                <div class="hr"></div>

                <div class="row">
                  <button class="btn" id="btnGoOdonto">Abrir odontograma deste paciente</button>
                  <button class="btn" id="btnGoDocs">Gerar documentos</button>
                  <button class="btn danger" id="btnDeletePatient">Excluir paciente</button>
                </div>

                <div class="printPreviewHint">
                  Tudo salva automaticamente ao digitar. (Sem bot√£o ‚ÄúSalvar‚Äù pra n√£o te atrapalhar.)
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="view_odontogram" class="view" style="display:none;">
          <div class="panel">
            <h3>Odontograma</h3>
            <div class="grid two">
              <div class="field">
                <label>Paciente</label>
                <select id="odoPatient"></select>
              </div>
              <div class="row" style="align-self:end;">
                <span class="pill">Clique no dente para alternar: <strong style="color:var(--accent)">OK</strong> ‚Üí <strong style="color:var(--warn)">Aten√ß√£o</strong> ‚Üí <strong style="color:var(--bad)">Problema</strong> ‚Üí Neutro</span>
              </div>
            </div>

            <div class="hr"></div>

            <div class="odoWrap">
              <div class="panel" style="padding:12px;">
                <h3>Mapa (simplificado)</h3>
                <div class="teeth" id="teethGrid"></div>
              </div>

              <div class="panel">
                <h3>Legenda / Nota</h3>
                <div class="grid">
                  <div class="pill"><span class="dot"></span> OK / restaurado</div>
                  <div class="pill" style="border-color: rgba(255,204,102,.25);">üü° Aten√ß√£o (sens√≠vel/les√£o inicial)</div>
                  <div class="pill" style="border-color: rgba(255,92,122,.25);">üî¥ Problema (c√°rie/fratura/extra√ß√£o indicada)</div>
                </div>

                <div class="sp"></div>
                <div class="field">
                  <label>Observa√ß√£o do odontograma</label>
                  <textarea id="odoNote" placeholder="Anote planejamento, condutas, etc."></textarea>
                </div>

                <div class="row">
                  <button class="btn ghost" id="btnClearOdo">Limpar odontograma</button>
                </div>
              </div>
            </div>

            <div class="printPreviewHint">
              Este odontograma √© funcional e salva por paciente. Depois a gente evolui para um odontograma ‚Äúultra‚Äù (faces/cores/√≠cones).
            </div>
          </div>
        </div>

        <div id="view_docs" class="view" style="display:none;">
          <div class="panel">
            <h3>Documentos A4 (sem duplicar / sem quebrar bordas)</h3>

            <div class="grid two">
              <div class="field">
                <label>Paciente</label>
                <select id="docPatient"></select>
              </div>
              <div class="field">
                <label>Documento</label>
                <select id="docType">
                  <option value="receita">Receitu√°rio</option>
                  <option value="atestado">Atestado</option>
                  <option value="orcamento">Or√ßamento</option>
                </select>
              </div>
            </div>

            <div class="hr"></div>

            <div id="doc_receita" class="docBlock">
              <div class="grid two">
                <div class="field">
                  <label>Modelo r√°pido</label>
                  <select id="rxTemplate">
                    <option value="livre">Livre (sem modelo)</option>
                    <option value="analgesico">Analg√©sico (modelo)</option>
                    <option value="antiinflamatorio">Anti-inflamat√≥rio (modelo)</option>
                    <option value="antibiotico">Antibi√≥tico (modelo)</option>
                  </select>
                </div>
                <div class="field">
                  <label>Data</label>
                  <input id="docDate" type="date" />
                </div>
              </div>

              <div class="sp"></div>

              <div class="field">
                <label>Texto da receita</label>
                <textarea id="rxText" placeholder="Ex.: Dipirona 500mg, 1 cp 6/6h por 3 dias..."></textarea>
              </div>

              <div class="printPreviewHint">Dica: selecione um modelo r√°pido e edite do seu jeito.</div>
            </div>

            <div id="doc_atestado" class="docBlock" style="display:none;">
              <div class="grid three">
                <div class="field">
                  <label>Data</label>
                  <input id="attDate" type="date" />
                </div>
                <div class="field">
                  <label>Dias de afastamento</label>
                  <input id="attDays" type="number" min="0" value="1" />
                </div>
                <div class="field">
                  <label>Motivo (opcional)</label>
                  <input id="attReason" placeholder="procedimento odontol√≥gico..." />
                </div>
              </div>
              <div class="sp"></div>
              <div class="field">
                <label>Observa√ß√µes</label>
                <textarea id="attObs" placeholder="Ex.: recomenda√ß√µes, retorno, etc."></textarea>
              </div>
            </div>

            <div id="doc_orcamento" class="docBlock" style="display:none;">
              <div class="grid two">
                <div class="field">
                  <label>Data</label>
                  <input id="orcDate" type="date" />
                </div>
                <div class="field">
                  <label>Validade (dias)</label>
                  <input id="orcValidity" type="number" min="0" value="15" />
                </div>
              </div>
              <div class="sp"></div>
              <div class="field">
                <label>Itens (texto livre ‚Äî sem soma autom√°tica, do jeito que voc√™ pediu)</label>
                <textarea id="orcItems" placeholder="1) Exodontia do 18 .... R$ ...&#10;2) ..."></textarea>
              </div>
              <div class="field">
                <label>Observa√ß√µes</label>
                <textarea id="orcObs" placeholder="condi√ß√µes, formas de pagamento, etc."></textarea>
              </div>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn ok" id="btnGenerateDoc">Gerar / Imprimir A4</button>
              <button class="btn ghost" id="btnSaveDocDefaults">Salvar padr√µes</button>
            </div>

            <div class="printPreviewHint">
              ‚ÄúGerar‚Äù abre uma janela A4 √∫nica (n√£o duplica c√≥pias). Voc√™ imprime pelo navegador (Ctrl+P).
            </div>
          </div>
        </div>

        <div id="view_backup" class="view" style="display:none;">
          <div class="panel">
            <h3>Backup & Restore</h3>
            <div class="muted" style="font-size:13px; line-height:1.5;">
              Aqui √© onde sua ‚Äúmem√≥ria boa‚Äù vira port√°til: exporta um <strong style="color:var(--accent)">JSON</strong> com tudo
              (pacientes, agenda, odontograma, documentos e foto do profissional).
            </div>

            <div class="hr"></div>

            <div class="grid two">
              <div class="panel" style="padding:12px;">
                <h3>Exportar</h3>
                <button class="btn ok" id="btnExport">Baixar Backup (.json)</button>
                <div class="printPreviewHint">Use isso antes de trocar de aparelho.</div>
              </div>
              <div class="panel" style="padding:12px;">
                <h3>Restaurar</h3>
                <input id="importFile" type="file" accept="application/json" />
                <div class="printPreviewHint">Selecione o JSON e ele restaura tudo.</div>
                <button class="btn" id="btnImport">Restaurar agora</button>
              </div>
            </div>
          </div>
        </div>

        <div id="view_settings" class="view" style="display:none;">
          <div class="panel">
            <h3>Configura√ß√µes</h3>
            <div class="grid two">
              <div class="field">
                <label>Nome do profissional</label>
                <input id="setProName" />
              </div>
              <div class="field">
                <label>Senha do sistema</label>
                <input id="setPass" type="password" placeholder="Deixe vazio para n√£o alterar" />
              </div>
            </div>

            <div class="sp"></div>

            <div class="grid two">
              <div class="field">
                <label>Contato (vai nos documentos)</label>
                <input id="setContact" placeholder="(91) 99987-3835" />
              </div>
              <div class="field">
                <label>Cidade/UF</label>
                <input id="setCity" placeholder="Bel√©m - Par√° - Brasil" />
              </div>
            </div>

            <div class="sp"></div>

            <div class="field">
              <label>Rodap√© dos documentos (CRM/CRO/endere√ßo, etc.)</label>
              <input id="setFooter" placeholder="Ex.: CRO-PA XXXXX ‚Ä¢ Endere√ßo..." />
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn ok" id="btnSaveSettings">Salvar configura√ß√µes</button>
              <button class="btn danger" id="btnWipe">Apagar tudo (reset total)</button>
            </div>

            <div class="printPreviewHint">
              Reset total apaga a mem√≥ria local do aparelho. Use com cuidado.
            </div>
          </div>
        </div>

      </main>
    </div>
  </section>

  <!-- ===== MODAL (forms) ===== -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="modalTitle">T√≠tulo</h3>
        <button class="btn ghost" id="modalClose">Fechar</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     *  BTX Clinic ‚Äî Data
     ***********************/
    const DB_KEY = "BTX_CLINIC_DB_V1";

    const defaultDB = {
      settings:{
        proName: "Dr. Orlando Abreu Gomes da Silva",
        contact: "(91) 99987-3835",
        city: "Bel√©m - Par√° - Brasil",
        footer: "BTX Tech ‚Ä¢ Startup de Biotecnologia",
        passHash: null, // set on first run
      },
      proPhotoDataUrl: null,
      patients: [],     // {id, name, phone, dob, tags, notes, file:{name,type,dataUrl}|null, createdAt, updatedAt}
      appointments: [], // {id, date(YYYY-MM-DD), time(HH:MM), patientId, patientNameCache, procedure, status(pendente|confirmado|faltou), notes, createdAt, updatedAt}
      odontograms: {},  // patientId -> {map: {toothId: state(0..3)}, note}
      docDefaults: {
        rxTemplate: "livre",
        rxText: "",
        docDate: null,
        attDays: 1,
        attReason: "",
        attObs: "",
        orcValidity: 15,
        orcItems: "",
        orcObs: ""
      }
    };

    function nowISO(){ return new Date().toISOString(); }
    function uid(){
      return "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function todayYMD(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function monthKey(ymd){ return ymd.slice(0,7); } // YYYY-MM

    // Simple hash (not crypto-grade; for offline local gate it's ok)
    async function hashPass(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    let DB = null;
    function loadDB(){
      const raw = localStorage.getItem(DB_KEY);
      if(!raw){
        DB = structuredClone(defaultDB);
        return saveDB();
      }
      try{
        DB = JSON.parse(raw);
      }catch(e){
        DB = structuredClone(defaultDB);
      }
      // migrations / guards
      DB.settings ||= structuredClone(defaultDB.settings);
      DB.patients ||= [];
      DB.appointments ||= [];
      DB.odontograms ||= {};
      DB.docDefaults ||= structuredClone(defaultDB.docDefaults);
      return saveDB(false);
    }
    function saveDB(showToast=true){
      localStorage.setItem(DB_KEY, JSON.stringify(DB));
      if(showToast) toast("Salvo <strong>offline</strong> ‚úÖ");
    }

    function toast(html){
      const el = document.getElementById("toast");
      el.innerHTML = html;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=> el.style.display="none", 1800);
    }

    /***********************
     *  UI references
     ***********************/
    const landing = document.getElementById("landing");
    const app = document.getElementById("app");

    const proPhotoBox = document.getElementById("proPhotoBox");
    const proPhotoInput = document.getElementById("proPhotoInput");
    const sideAvatar = document.getElementById("sideAvatar");

    const btnLogin = document.getElementById("btnLogin");
    const loginPass = document.getElementById("loginPass");
    const btnResetAll = document.getElementById("btnResetAll");

    const navButtons = Array.from(document.querySelectorAll(".nav button[data-view]"));
    const viewTitle = document.getElementById("viewTitle");
    const todayLabel = document.getElementById("todayLabel");

    const quickNewAppt = document.getElementById("quickNewAppt");
    const quickNewPatient = document.getElementById("quickNewPatient");
    const btnLogout = document.getElementById("btnLogout");

    // KPIs landing
    const kpiPatients = document.getElementById("kpiPatients");
    const kpiToday = document.getElementById("kpiToday");
    const kpiMonth = document.getElementById("kpiMonth");

    // Dashboard
    const dashTodayCount = document.getElementById("dashTodayCount");
    const dashWeekCount = document.getElementById("dashWeekCount");
    const dashPatients = document.getElementById("dashPatients");
    const globalSearch = document.getElementById("globalSearch");
    const globalResults = document.getElementById("globalResults");
    const nextAppts = document.getElementById("nextAppts");

    // Agenda
    const agendaDate = document.getElementById("agendaDate");
    const agendaSummary = document.getElementById("agendaSummary");
    const agendaTableBody = document.querySelector("#agendaTable tbody");
    const btnNewAppt = document.getElementById("btnNewAppt");
    const btnToday = document.getElementById("btnToday");

    // Patients
    const patientSearch = document.getElementById("patientSearch");
    const patientList = document.getElementById("patientList");
    const btnNewPatient = document.getElementById("btnNewPatient");
    const patientEditorEmpty = document.getElementById("patientEditorEmpty");
    const patientEditor = document.getElementById("patientEditor");

    const p_name = document.getElementById("p_name");
    const p_phone = document.getElementById("p_phone");
    const p_dob = document.getElementById("p_dob");
    const p_tags = document.getElementById("p_tags");
    const p_notes = document.getElementById("p_notes");
    const p_file = document.getElementById("p_file");
    const p_filePreview = document.getElementById("p_filePreview");
    const btnDeletePatient = document.getElementById("btnDeletePatient");
    const btnGoOdonto = document.getElementById("btnGoOdonto");
    const btnGoDocs = document.getElementById("btnGoDocs");

    let currentPatientId = null;

    // Odonto
    const odoPatient = document.getElementById("odoPatient");
    const teethGrid = document.getElementById("teethGrid");
    const odoNote = document.getElementById("odoNote");
    const btnClearOdo = document.getElementById("btnClearOdo");

    // Docs
    const docPatient = document.getElementById("docPatient");
    const docType = document.getElementById("docType");

    const doc_receita = document.getElementById("doc_receita");
    const doc_atestado = document.getElementById("doc_atestado");
    const doc_orcamento = document.getElementById("doc_orcamento");

    const rxTemplate = document.getElementById("rxTemplate");
    const docDate = document.getElementById("docDate");
    const rxText = document.getElementById("rxText");

    const attDate = document.getElementById("attDate");
    const attDays = document.getElementById("attDays");
    const attReason = document.getElementById("attReason");
    const attObs = document.getElementById("attObs");

    const orcDate = document.getElementById("orcDate");
    const orcValidity = document.getElementById("orcValidity");
    const orcItems = document.getElementById("orcItems");
    const orcObs = document.getElementById("orcObs");

    const btnGenerateDoc = document.getElementById("btnGenerateDoc");
    const btnSaveDocDefaults = document.getElementById("btnSaveDocDefaults");

    // Backup
    const btnExport = document.getElementById("btnExport");
    const importFile = document.getElementById("importFile");
    const btnImport = document.getElementById("btnImport");

    // Settings
    const setProName = document.getElementById("setProName");
    const setPass = document.getElementById("setPass");
    const setContact = document.getElementById("setContact");
    const setCity = document.getElementById("setCity");
    const setFooter = document.getElementById("setFooter");
    const btnSaveSettings = document.getElementById("btnSaveSettings");
    const btnWipe = document.getElementById("btnWipe");

    // Modal
    const modalBack = document.getElementById("modalBack");
    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const modalClose = document.getElementById("modalClose");

    function openModal(title, html){
      modalTitle.textContent = title;
      modalBody.innerHTML = html;
      modalBack.style.display = "flex";
    }
    function closeModal(){
      modalBack.style.display = "none";
      modalBody.innerHTML = "";
    }
    modalClose.addEventListener("click", closeModal);
    modalBack.addEventListener("click", (e)=>{ if(e.target === modalBack) closeModal(); });

    /***********************
     *  App logic
     ***********************/
    function setView(name){
      // nav
      navButtons.forEach(b=> b.classList.toggle("active", b.dataset.view===name));
      // views
      document.querySelectorAll(".view").forEach(v=> v.style.display="none");
      document.getElementById("view_"+name).style.display = "block";
      const titles = {
        dash:"Dashboard",
        agenda:"Agenda",
        patients:"Pacientes / Ficha",
        odontogram:"Odontograma",
        docs:"Documentos (A4)",
        backup:"Backup",
        settings:"Configura√ß√µes"
      };
      viewTitle.textContent = titles[name] || "BTX Clinic";
      if(name==="agenda") renderAgenda();
      if(name==="patients") renderPatients();
      if(name==="odontogram") renderOdontogram();
      if(name==="docs") renderDocs();
      if(name==="backup") renderBackup();
      if(name==="settings") renderSettings();
      if(name==="dash") renderDash();
    }

    function goApp(){
      landing.style.display="none";
      app.style.display="block";
      todayLabel.textContent = new Date().toLocaleDateString("pt-BR", { weekday:"long", year:"numeric", month:"long", day:"numeric" });
      hydrateSideProfile();
      renderEverything();
      setView("dash");
    }
    function goLanding(){
      landing.style.display="grid";
      app.style.display="none";
      loginPass.value = "";
      renderLandingKPIs();
    }

    function hydrateSideProfile(){
      document.getElementById("proNameSide").textContent = DB.settings.proName || defaultDB.settings.proName;
      // avatar photo
      if(DB.proPhotoDataUrl){
        sideAvatar.innerHTML = `<img alt="Foto" src="${DB.proPhotoDataUrl}">`;
      }else{
        sideAvatar.textContent = "BTX";
      }
    }

    function renderLandingKPIs(){
      kpiPatients.textContent = DB.patients.length;
      const t = todayYMD();
      const todayCount = DB.appointments.filter(a=>a.date===t).length;
      kpiToday.textContent = todayCount;
      const mk = t.slice(0,7);
      kpiMonth.textContent = DB.appointments.filter(a=>a.date.startsWith(mk)).length;
    }

    function renderEverything(){
      renderLandingKPIs();
      renderDash();
      // keep selects refreshed
      fillPatientSelects();
      // agenda date default
      agendaDate.value = todayYMD();
      agendaSummary.value = "";
      renderAgenda();
    }

    function fillPatientSelects(){
      const opts = DB.patients
        .slice()
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""))
        .map(p=> `<option value="${p.id}">${escapeHtml(p.name || "(sem nome)")}${p.phone?` ‚Ä¢ ${escapeHtml(p.phone)}`:""}</option>`)
        .join("");

      odoPatient.innerHTML = `<option value="">‚Äî selecione ‚Äî</option>` + opts;
      docPatient.innerHTML = `<option value="">‚Äî selecione ‚Äî</option>` + opts;

      // keep selection if possible
      if(currentPatientId && DB.patients.some(p=>p.id===currentPatientId)){
        // no-op
      }else{
        currentPatientId = null;
      }
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /***********************
     *  Login
     ***********************/
    async function ensurePass(){
      if(!DB.settings.passHash){
        DB.settings.passHash = await hashPass("btx1234");
        saveDB(false);
      }
    }

    btnLogin.addEventListener("click", async ()=>{
      await ensurePass();
      const val = loginPass.value || "";
      const h = await hashPass(val);
      if(h === DB.settings.passHash){
        toast("Acesso <strong>liberado</strong> ‚úÖ");
        goApp();
      }else{
        toast("Senha <strong>incorreta</strong> ‚ùå");
        loginPass.focus();
      }
    });

    loginPass.addEventListener("keydown", (e)=>{
      if(e.key==="Enter") btnLogin.click();
    });

    btnLogout.addEventListener("click", ()=>{
      toast("Saiu do sistema.");
      goLanding();
    });

    btnResetAll.addEventListener("click", ()=>{
      const ok = confirm("Reset TOTAL? Isso apaga pacientes, agenda, odontograma e documentos deste dispositivo.");
      if(!ok) return;
      localStorage.removeItem(DB_KEY);
      loadDB();
      initUI();
      toast("Reset feito ‚úÖ");
    });

    /***********************
     *  Photo upload
     ***********************/
    function renderProPhoto(){
      if(DB.proPhotoDataUrl){
        proPhotoBox.innerHTML = `
          <img alt="Foto do profissional" src="${DB.proPhotoDataUrl}">
          <div class="hint"><div>Toque para alterar</div><span>FICA SALVO</span></div>
          <input id="proPhotoInput" type="file" accept="image/*" hidden />
        `;
        // rebind input
        const newInput = proPhotoBox.querySelector("#proPhotoInput");
        newInput.addEventListener("change", onProPhotoPicked);
      }else{
        // keep original already in HTML
      }
      hydrateSideProfile();
    }

    async function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = ()=> reject(new Error("Falha ao ler arquivo"));
        r.readAsDataURL(file);
      });
    }

    async function onProPhotoPicked(e){
      const f = e.target.files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      DB.proPhotoDataUrl = dataUrl;
      saveDB(false);
      renderProPhoto();
      toast("Foto salva ‚úÖ");
    }

    proPhotoBox.addEventListener("click", ()=>{
      const input = proPhotoBox.querySelector("input[type=file]") || proPhotoInput;
      input.click();
    });
    proPhotoInput.addEventListener("change", onProPhotoPicked);

    /***********************
     *  Dashboard
     ***********************/
    function renderDash(){
      dashPatients.textContent = DB.patients.length;

      const t = todayYMD();
      const today = DB.appointments.filter(a=>a.date===t).length;
      dashTodayCount.textContent = today;

      const start = new Date();
      const end = new Date();
      end.setDate(end.getDate()+6);
      const startY = start.toISOString().slice(0,10);
      const endY = end.toISOString().slice(0,10);
      const week = DB.appointments.filter(a=>a.date>=startY && a.date<=endY).length;
      dashWeekCount.textContent = week;

      // next appts (10)
      const upcoming = DB.appointments
        .slice()
        .filter(a=>a.date >= t)
        .sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time))
        .slice(0,10);

      if(upcoming.length===0){
        nextAppts.innerHTML = `<div class="muted">Nenhum agendamento futuro.</div>`;
      }else{
        nextAppts.innerHTML = upcoming.map(a=>{
          const st = badgeStatus(a.status);
          const p = getPatientById(a.patientId);
          const name = p?.name || a.patientNameCache || "(paciente)";
          const when = `${formatBRDate(a.date)} ‚Ä¢ ${a.time||"--:--"}`;
          return `
            <div style="padding:10px 10px; border:1px solid rgba(150,180,255,.10); border-radius:16px; background:rgba(255,255,255,.02); margin-bottom:10px;">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                <div><strong style="color:var(--text)">${escapeHtml(name)}</strong><div class="muted" style="font-size:12px;margin-top:2px;">${escapeHtml(when)} ‚Ä¢ ${escapeHtml(a.procedure||"‚Äî")}</div></div>
                <div>${st}</div>
              </div>
            </div>
          `;
        }).join("");
      }
    }

    function badgeStatus(s){
      const val = (s||"pendente").toLowerCase();
      if(val==="confirmado") return `<span class="pill" style="border-color:rgba(24,247,168,.30);">üü¢ confirmado</span>`;
      if(val==="faltou") return `<span class="pill" style="border-color:rgba(255,92,122,.30);">üî¥ faltou</span>`;
      return `<span class="pill" style="border-color:rgba(255,204,102,.30);">üü° pendente</span>`;
    }

    function formatBRDate(ymd){
      const [y,m,d] = ymd.split("-");
      return `${d}/${m}/${y}`;
    }

    globalSearch.addEventListener("input", ()=>{
      const q = (globalSearch.value||"").trim().toLowerCase();
      if(!q){ globalResults.innerHTML=""; return; }

      const pHits = DB.patients.filter(p=>{
        return (p.name||"").toLowerCase().includes(q) || (p.phone||"").toLowerCase().includes(q);
      }).slice(0,6);

      const aHits = DB.appointments.filter(a=>{
        const p = getPatientById(a.patientId);
        const nm = (p?.name || a.patientNameCache || "").toLowerCase();
        return nm.includes(q) || (a.procedure||"").toLowerCase().includes(q) || (a.notes||"").toLowerCase().includes(q);
      }).slice(0,8);

      const html = `
        <div class="panel" style="padding:12px;">
          <h3>Resultados</h3>
          <div class="muted" style="font-size:13px;">
            <strong style="color:var(--accent)">Pacientes</strong>: ${pHits.length} ‚Ä¢
            <strong style="color:var(--accent)">Agendamentos</strong>: ${aHits.length}
          </div>
          <div class="hr"></div>
          <div class="muted" style="font-size:13px;">
            ${pHits.map(p=>`
              <div class="row" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(150,180,255,.10); border-radius:14px; margin-bottom:8px; background:rgba(255,255,255,.02);">
                <div><strong style="color:var(--text)">${escapeHtml(p.name||"(sem nome)")}</strong>
                  <div class="muted2" style="font-size:12px;">${escapeHtml(p.phone||"")}</div>
                </div>
                <button class="btn ghost" onclick="window.__openPatient('${p.id}')">Abrir</button>
              </div>
            `).join("") || `<div>Nenhum paciente.</div>`}

            <div class="sp"></div>
            ${aHits.map(a=>{
              const p = getPatientById(a.patientId);
              const nm = p?.name || a.patientNameCache || "(paciente)";
              return `
                <div class="row" style="justify-content:space-between; padding:8px 10px; border:1px solid rgba(150,180,255,.10); border-radius:14px; margin-bottom:8px; background:rgba(255,255,255,.02);">
                  <div>
                    <strong style="color:var(--text)">${escapeHtml(nm)}</strong>
                    <div class="muted2" style="font-size:12px;">${escapeHtml(formatBRDate(a.date))} ‚Ä¢ ${escapeHtml(a.time||"--:--")} ‚Ä¢ ${escapeHtml(a.procedure||"‚Äî")}</div>
                  </div>
                  <button class="btn ghost" onclick="window.__openAgendaDate('${a.date}')">Ver dia</button>
                </div>
              `;
            }).join("") || `<div>Nenhum agendamento.</div>`}
          </div>
        </div>
      `;
      globalResults.innerHTML = html;
    });

    window.__openPatient = (id)=>{
      setView("patients");
      openPatient(id);
    };
    window.__openAgendaDate = (ymd)=>{
      setView("agenda");
      agendaDate.value = ymd;
      renderAgenda();
    };

    /***********************
     *  Agenda
     ***********************/
    function getPatientById(id){
      return DB.patients.find(p=>p.id===id) || null;
    }

    function renderAgenda(){
      const d = agendaDate.value || todayYMD();
      const dayAppts = DB.appointments
        .filter(a=>a.date===d)
        .sort((a,b)=> (a.time||"").localeCompare(b.time||""));

      agendaSummary.value = `${dayAppts.length} paciente(s) no dia ‚Ä¢ ${formatBRDate(d)}`;

      agendaTableBody.innerHTML = dayAppts.map(a=>{
        const p = getPatientById(a.patientId);
        const nm = p?.name || a.patientNameCache || "(paciente)";
        return `
          <tr>
            <td><strong style="color:var(--text)">${escapeHtml(a.time||"--:--")}</strong></td>
            <td>
              <strong style="color:var(--text)">${escapeHtml(nm)}</strong>
              <div class="muted2" style="font-size:12px;">${escapeHtml(p?.phone || "")}</div>
            </td>
            <td>${escapeHtml(a.procedure||"‚Äî")}</td>
            <td>${badgeStatus(a.status)}</td>
            <td>
              <div class="row">
                <button class="btn ghost" onclick="window.__editAppt('${a.id}')">Editar</button>
                <button class="btn danger" onclick="window.__delAppt('${a.id}')">Excluir</button>
              </div>
            </td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="5" class="muted">Nenhum agendamento neste dia.</td></tr>`;
      renderDash(); // keep dashboard live
      renderLandingKPIs();
    }

    function openApptModal(existingId=null){
      const d = agendaDate.value || todayYMD();
      const a = existingId ? DB.appointments.find(x=>x.id===existingId) : null;

      const patientsOptions = DB.patients
        .slice()
        .sort((x,y)=> (x.name||"").localeCompare(y.name||""))
        .map(p=> `<option value="${p.id}" ${a?.patientId===p.id?"selected":""}>${escapeHtml(p.name||"(sem nome)")}${p.phone?` ‚Ä¢ ${escapeHtml(p.phone)}`:""}</option>`)
        .join("");

      openModal(existingId? "Editar agendamento" : "Novo agendamento", `
        <div class="grid two">
          <div class="field">
            <label>Data</label>
            <input id="m_date" type="date" value="${escapeHtml(a?.date || d)}">
          </div>
          <div class="field">
            <label>Hora</label>
            <input id="m_time" type="time" value="${escapeHtml(a?.time || "08:00")}">
          </div>
          <div class="field">
            <label>Paciente</label>
            <select id="m_patient">${patientsOptions}</select>
            <div class="muted2" style="font-size:12px; margin-top:6px;">Se n√£o aparecer, crie o paciente primeiro.</div>
          </div>
          <div class="field">
            <label>Status</label>
            <select id="m_status">
              ${["pendente","confirmado","faltou"].map(s=>`<option value="${s}" ${(a?.status||"pendente")===s?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="sp"></div>

        <div class="field">
          <label>Procedimento</label>
          <input id="m_proc" value="${escapeHtml(a?.procedure || "")}" placeholder="Ex.: avalia√ß√£o, exodontia, retorno...">
        </div>

        <div class="sp"></div>

        <div class="field">
          <label>Observa√ß√µes</label>
          <textarea id="m_notes" placeholder="(opcional)">${escapeHtml(a?.notes || "")}</textarea>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:flex-end;">
          <button class="btn ghost" onclick="(${closeModal.toString()})()">Cancelar</button>
          <button class="btn ok" id="m_save">${existingId?"Salvar":"Criar"}</button>
        </div>
      `);

      // bind save
      setTimeout(()=>{
        document.getElementById("m_save").addEventListener("click", ()=>{
          const date = document.getElementById("m_date").value;
          const time = document.getElementById("m_time").value;
          const patientId = document.getElementById("m_patient").value;
          const status = document.getElementById("m_status").value;
          const procedure = document.getElementById("m_proc").value;
          const notes = document.getElementById("m_notes").value;

          if(!date || !time || !patientId){
            toast("Preencha <strong>data/hora/paciente</strong>.");
            return;
          }
          const p = getPatientById(patientId);
          const nameCache = p?.name || "";

          if(existingId && a){
            a.date = date;
            a.time = time;
            a.patientId = patientId;
            a.patientNameCache = nameCache;
            a.status = status;
            a.procedure = procedure;
            a.notes = notes;
            a.updatedAt = nowISO();
          }else{
            DB.appointments.push({
              id: uid(),
              date, time,
              patientId,
              patientNameCache: nameCache,
              procedure,
              status,
              notes,
              createdAt: nowISO(),
              updatedAt: nowISO()
            });
          }
          saveDB(false);
          closeModal();
          agendaDate.value = date;
          renderAgenda();
          toast("Agendamento <strong>salvo</strong> ‚úÖ");
        });
      }, 0);
    }

    window.__editAppt = (id)=> openApptModal(id);
    window.__delAppt = (id)=>{
      const ok = confirm("Excluir este agendamento?");
      if(!ok) return;
      DB.appointments = DB.appointments.filter(a=>a.id!==id);
      saveDB(false);
      renderAgenda();
      toast("Agendamento exclu√≠do.");
    };

    btnNewAppt.addEventListener("click", ()=>{
      if(DB.patients.length===0){
        toast("Crie um <strong>paciente</strong> primeiro.");
        setView("patients");
        return;
      }
      openApptModal(null);
    });
    btnToday.addEventListener("click", ()=>{
      agendaDate.value = todayYMD();
      renderAgenda();
    });
    agendaDate.addEventListener("change", renderAgenda);

    quickNewAppt.addEventListener("click", ()=>{
      setView("agenda");
      btnNewAppt.click();
    });

    /***********************
     *  Patients
     ***********************/
    function renderPatients(){
      const q = (patientSearch.value||"").trim().toLowerCase();
      const list = DB.patients
        .slice()
        .filter(p=> !q || (p.name||"").toLowerCase().includes(q) || (p.phone||"").toLowerCase().includes(q))
        .sort((a,b)=> (a.name||"").localeCompare(b.name||""));

      patientList.innerHTML = list.map(p=>{
        const last = p.updatedAt ? new Date(p.updatedAt).toLocaleString("pt-BR") : "";
        return `
          <div class="row" style="justify-content:space-between; padding:10px 12px; border:1px solid rgba(150,180,255,.10); border-radius:18px; background:rgba(255,255,255,.02); margin-bottom:10px;">
            <div style="min-width:0;">
              <strong style="color:var(--text)">${escapeHtml(p.name || "(sem nome)")}</strong>
              <div class="muted2" style="font-size:12px; margin-top:2px;">
                ${escapeHtml(p.phone||"")} ${p.tags?` ‚Ä¢ ${escapeHtml(p.tags)}`:""}
              </div>
              <div class="muted2" style="font-size:11px; margin-top:2px;">Atualizado: ${escapeHtml(last)}</div>
            </div>
            <div class="row">
              <button class="btn ghost" onclick="window.__openPatient('${p.id}')">Abrir</button>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted">Nenhum paciente.</div>`;

      // keep editor state
      if(currentPatientId){
        openPatient(currentPatientId, true);
      }else{
        patientEditorEmpty.style.display="block";
        patientEditor.style.display="none";
      }

      fillPatientSelects();
      renderDash();
      renderLandingKPIs();
    }

    function openPatient(id, silent=false){
      const p = getPatientById(id);
      if(!p) return;
      currentPatientId = id;

      patientEditorEmpty.style.display="none";
      patientEditor.style.display="block";

      p_name.value = p.name || "";
      p_phone.value = p.phone || "";
      p_dob.value = p.dob || "";
      p_tags.value = p.tags || "";
      p_notes.value = p.notes || "";

      renderPatientFilePreview(p);

      if(!silent) toast("Paciente aberto ‚úÖ");
      fillPatientSelects();

      // update selects
      odoPatient.value = id;
      docPatient.value = id;
    }

    function renderPatientFilePreview(p){
      if(p.file?.dataUrl){
        if((p.file.type||"").startsWith("image/")){
          p_filePreview.innerHTML = `
            <div class="row" style="align-items:flex-start;">
              <img src="${p.file.dataUrl}" alt="Anexo" style="width:120px; height:120px; object-fit:cover; border-radius:16px; border:1px solid rgba(150,180,255,.12);">
              <div>
                <div><strong style="color:var(--text)">${escapeHtml(p.file.name||"anexo")}</strong></div>
                <div class="muted2" style="font-size:12px;">${escapeHtml(p.file.type||"")}</div>
              </div>
            </div>
          `;
        }else{
          p_filePreview.innerHTML = `
            <div><strong style="color:var(--text)">${escapeHtml(p.file.name||"anexo")}</strong></div>
            <div class="muted2" style="font-size:12px;">${escapeHtml(p.file.type||"")}</div>
          `;
        }
      }else{
        p_filePreview.textContent = "Nenhum";
      }
    }

    function upsertPatientFromEditor(){
      const p = getPatientById(currentPatientId);
      if(!p) return;
      p.name = p_name.value.trim();
      p.phone = p_phone.value.trim();
      p.dob = p_dob.value;
      p.tags = p_tags.value.trim();
      p.notes = p_notes.value;
      p.updatedAt = nowISO();

      // keep cache in appointments
      DB.appointments.forEach(a=>{
        if(a.patientId===p.id) a.patientNameCache = p.name || a.patientNameCache;
      });

      saveDB(false);
      renderPatients();
    }

    // autosave on input
    [p_name,p_phone,p_dob,p_tags,p_notes].forEach(el=>{
      el.addEventListener("input", ()=>{
        if(!currentPatientId) return;
        upsertPatientFromEditor();
      });
    });

    p_file.addEventListener("change", async ()=>{
      const f = p_file.files?.[0];
      if(!f || !currentPatientId) return;
      const p = getPatientById(currentPatientId);
      const dataUrl = await fileToDataUrl(f);
      p.file = { name:f.name, type:f.type, dataUrl };
      p.updatedAt = nowISO();
      saveDB(false);
      renderPatientFilePreview(p);
      toast("Anexo salvo ‚úÖ");
    });

    btnDeletePatient.addEventListener("click", ()=>{
      if(!currentPatientId) return;
      const p = getPatientById(currentPatientId);
      const ok = confirm(`Excluir paciente "${p?.name||"(sem nome)"}"? Isso tamb√©m remove agendamentos ligados a ele.`);
      if(!ok) return;
      DB.patients = DB.patients.filter(x=>x.id!==currentPatientId);
      DB.appointments = DB.appointments.filter(a=>a.patientId!==currentPatientId);
      delete DB.odontograms[currentPatientId];
      currentPatientId = null;
      saveDB(false);
      renderPatients();
      toast("Paciente exclu√≠do.");
    });

    btnGoOdonto.addEventListener("click", ()=>{
      if(!currentPatientId){ toast("Selecione um paciente."); return; }
      setView("odontogram");
      odoPatient.value = currentPatientId;
      renderOdontogram();
    });

    btnGoDocs.addEventListener("click", ()=>{
      if(!currentPatientId){ toast("Selecione um paciente."); return; }
      setView("docs");
      docPatient.value = currentPatientId;
      renderDocs();
    });

    patientSearch.addEventListener("input", renderPatients);

    function openNewPatientModal(){
      openModal("Novo paciente", `
        <div class="grid two">
          <div class="field"><label>Nome</label><input id="np_name" placeholder="Nome completo"></div>
          <div class="field"><label>Telefone</label><input id="np_phone" placeholder="(91) 99999-9999"></div>
          <div class="field"><label>Data de nascimento</label><input id="np_dob" type="date"></div>
          <div class="field"><label>Observa√ß√µes r√°pidas</label><input id="np_tags" placeholder="alergias, HAS, etc."></div>
        </div>
        <div class="sp"></div>
        <div class="field"><label>Anamnese / evolu√ß√£o</label><textarea id="np_notes" placeholder="Anamnese, queixa, conduta..."></textarea></div>
        <div class="hr"></div>
        <div class="row" style="justify-content:flex-end;">
          <button class="btn ghost" onclick="(${closeModal.toString()})()">Cancelar</button>
          <button class="btn ok" id="np_save">Criar</button>
        </div>
      `);

      setTimeout(()=>{
        document.getElementById("np_save").addEventListener("click", ()=>{
          const name = document.getElementById("np_name").value.trim();
          const phone = document.getElementById("np_phone").value.trim();
          const dob = document.getElementById("np_dob").value;
          const tags = document.getElementById("np_tags").value.trim();
          const notes = document.getElementById("np_notes").value;

          if(!name){
            toast("Digite o <strong>nome</strong>.");
            return;
          }
          const id = uid();
          DB.patients.push({
            id, name, phone, dob, tags, notes,
            file:null,
            createdAt: nowISO(),
            updatedAt: nowISO()
          });
          saveDB(false);
          closeModal();
          fillPatientSelects();
          setView("patients");
          openPatient(id);
          renderPatients();
          toast("Paciente criado ‚úÖ");
        });
      },0);
    }

    btnNewPatient.addEventListener("click", openNewPatientModal);
    quickNewPatient.addEventListener("click", ()=>{
      setView("patients");
      openNewPatientModal();
    });

    /***********************
     *  Odontogram (simplified)
     ***********************/
    const toothIds = [
      "18","17","16","15","14","13","12","11",
      "21","22","23","24","25","26","27","28",
      "48","47","46","45","44","43","42","41",
      "31","32","33","34","35","36","37","38",
    ];
    // state 0 neutral, 1 ok, 2 warn, 3 bad
    function odoGet(pid){
      DB.odontograms[pid] ||= { map:{}, note:"" };
      return DB.odontograms[pid];
    }
    function odoToggle(pid, tooth){
      const o = odoGet(pid);
      const cur = o.map[tooth] || 0;
      const nxt = (cur+1) % 4;
      o.map[tooth] = nxt;
      saveDB(false);
    }
    function odoClass(state){
      if(state===1) return "ok";
      if(state===2) return "warn";
      if(state===3) return "bad";
      return "";
    }
    function renderOdontogram(){
      fillPatientSelects();
      const pid = odoPatient.value;
      if(!pid){
        teethGrid.innerHTML = `<div class="muted">Selecione um paciente acima.</div>`;
        odoNote.value = "";
        return;
      }
      const o = odoGet(pid);
      teethGrid.innerHTML = toothIds.map(t=>{
        const st = o.map[t] || 0;
        const cls = odoClass(st);
        return `
          <div class="tooth" data-tooth="${t}">
            <div class="id"><span>${t}</span><span class="muted2">${st===0?"‚Äî":st===1?"OK":st===2?"AT": "PB"}</span></div>
            <div class="miniGrid">
              <div class="surf ${cls}">O</div>
              <div class="surf ${cls}">V</div>
              <div class="surf ${cls}">L</div>
              <div class="surf ${cls}">M</div>
              <div class="surf ${cls}">D</div>
              <div class="surf ${cls}">C</div>
            </div>
          </div>
        `;
      }).join("");

      teethGrid.querySelectorAll(".tooth").forEach(card=>{
        card.addEventListener("click", ()=>{
          const tooth = card.dataset.tooth;
          odoToggle(pid, tooth);
          renderOdontogram();
          toast("Odontograma atualizado ‚úÖ");
        });
      });

      odoNote.value = o.note || "";
    }

    odoPatient.addEventListener("change", ()=>{
      renderOdontogram();
      // sync for docs & patients
      docPatient.value = odoPatient.value;
      currentPatientId = odoPatient.value || null;
    });

    odoNote.addEventListener("input", ()=>{
      const pid = odoPatient.value;
      if(!pid) return;
      const o = odoGet(pid);
      o.note = odoNote.value;
      saveDB(false);
    });

    btnClearOdo.addEventListener("click", ()=>{
      const pid = odoPatient.value;
      if(!pid) return;
      const ok = confirm("Limpar odontograma deste paciente?");
      if(!ok) return;
      DB.odontograms[pid] = { map:{}, note:"" };
      saveDB(false);
      renderOdontogram();
      toast("Odontograma limpo.");
    });

    /***********************
     *  Docs (A4)
     ***********************/
    function renderDocs(){
      fillPatientSelects();

      // defaults
      const defs = DB.docDefaults || structuredClone(defaultDB.docDefaults);
      rxTemplate.value = defs.rxTemplate || "livre";
      rxText.value = defs.rxText || "";
      docDate.value = defs.docDate || todayYMD();

      attDate.value = defs.docDate || todayYMD();
      attDays.value = defs.attDays ?? 1;
      attReason.value = defs.attReason || "";
      attObs.value = defs.attObs || "";

      orcDate.value = defs.docDate || todayYMD();
      orcValidity.value = defs.orcValidity ?? 15;
      orcItems.value = defs.orcItems || "";
      orcObs.value = defs.orcObs || "";

      // show doc sections
      syncDocType();
    }

    function syncDocType(){
      const t = docType.value;
      doc_receita.style.display = (t==="receita") ? "block" : "none";
      doc_atestado.style.display = (t==="atestado") ? "block" : "none";
      doc_orcamento.style.display = (t==="orcamento") ? "block" : "none";
    }
    docType.addEventListener("change", syncDocType);

    rxTemplate.addEventListener("change", ()=>{
      // quick models (edit as you like)
      const t = rxTemplate.value;
      if(t==="analgesico"){
        rxText.value = "1) Dipirona 500 mg ‚Äî tomar 1 comprimido a cada 6 horas, por 3 dias, se dor.\n\n2) Orienta√ß√µes: repouso relativo, hidrata√ß√£o, retorno se piora.";
      }else if(t==="antiinflamatorio"){
        rxText.value = "1) Ibuprofeno 400 mg ‚Äî tomar 1 comprimido a cada 8 horas, por 3 dias, ap√≥s alimenta√ß√£o.\n\n2) Orienta√ß√µes: evitar √°lcool, retorno se gastralgia ou alergia.";
      }else if(t==="antibiotico"){
        rxText.value = "1) Amoxicilina 500 mg ‚Äî tomar 1 c√°psula a cada 8 horas, por 7 dias.\n\n2) Orienta√ß√µes: n√£o interromper antes do prazo, retornar em 48‚Äì72h para reavalia√ß√£o.";
      }
      saveDB(false);
    });

    btnSaveDocDefaults.addEventListener("click", ()=>{
      DB.docDefaults = {
        rxTemplate: rxTemplate.value,
        rxText: rxText.value,
        docDate: docDate.value || todayYMD(),
        attDays: Number(attDays.value||1),
        attReason: attReason.value,
        attObs: attObs.value,
        orcValidity: Number(orcValidity.value||15),
        orcItems: orcItems.value,
        orcObs: orcObs.value
      };
      saveDB(false);
      toast("Padr√µes salvos ‚úÖ");
    });

    // Single print window (avoid duplicates)
    let printWin = null;

    btnGenerateDoc.addEventListener("click", ()=>{
      const pid = docPatient.value;
      if(!pid){
        toast("Selecione um <strong>paciente</strong>.");
        return;
      }
      const p = getPatientById(pid);
      const pro = DB.settings;

      const type = docType.value;
      const date = (type==="receita") ? (docDate.value||todayYMD())
                 : (type==="atestado") ? (attDate.value||todayYMD())
                 : (orcDate.value||todayYMD());

      let bodyHtml = "";
      let title = "";

      if(type==="receita"){
        title = "Receitu√°rio";
        bodyHtml = `
          <div class="block">
            <h3>Prescri√ß√£o</h3>
            <pre>${escapeHtml(rxText.value || "")}</pre>
          </div>
        `;
      }else if(type==="atestado"){
        title = "Atestado";
        const days = Number(attDays.value||0);
        const reason = attReason.value?.trim();
        const obs = attObs.value?.trim();
        bodyHtml = `
          <div class="block">
            <h3>Atestado</h3>
            <p>Atesto para os devidos fins que o(a) paciente <strong>${escapeHtml(p?.name||"")}</strong>${p?.dob?` (nasc. ${escapeHtml(formatBRDate(p.dob))})`:""} esteve sob atendimento odontol√≥gico nesta data, necessitando de <strong>${days}</strong> dia(s) de afastamento${reason?` em raz√£o de ${escapeHtml(reason)}`:""}.</p>
            ${obs?`<p><strong>Observa√ß√µes:</strong> ${escapeHtml(obs)}</p>`:""}
          </div>
        `;
      }else{
        title = "Or√ßamento";
        const val = Number(orcValidity.value||0);
        const items = orcItems.value||"";
        const obs = orcObs.value||"";
        bodyHtml = `
          <div class="block">
            <h3>Itens</h3>
            <pre>${escapeHtml(items)}</pre>
            ${val?`<p><strong>Validade:</strong> ${val} dia(s).</p>`:""}
            ${obs?`<p><strong>Observa√ß√µes:</strong> ${escapeHtml(obs)}</p>`:""}
          </div>
        `;
      }

      const full = buildA4Doc({
        title,
        date,
        pro,
        patient: p,
        odo: DB.odontograms[pid] || {map:{}, note:""},
        extraBody: bodyHtml
      });

      if(!printWin || printWin.closed){
        printWin = window.open("", "BTX_PRINT", "width=900,height=1000");
      }
      printWin.document.open();
      printWin.document.write(full);
      printWin.document.close();
      printWin.focus();
    });

    function buildA4Doc({title,date,pro,patient,odo,extraBody}){
      const proName = pro.proName || "Profissional";
      const contact = pro.contact || "";
      const city = pro.city || "";
      const footer = pro.footer || "";

      const patientLine = `
        <div class="meta">
          <div><strong>Paciente:</strong> ${escapeHtml(patient?.name||"")}</div>
          <div><strong>Telefone:</strong> ${escapeHtml(patient?.phone||"")}</div>
          <div><strong>Data:</strong> ${escapeHtml(formatBRDate(date))}</div>
        </div>
      `;

      const odoNote = (odo?.note||"").trim();
      const odoSummary = summarizeOdo(odo?.map || {});
      const odoBlock = `
        <div class="block">
          <h3>Odontograma (resumo)</h3>
          <p>${escapeHtml(odoSummary || "Sem altera√ß√µes registradas.")}</p>
          ${odoNote?`<p><strong>Nota:</strong> ${escapeHtml(odoNote)}</p>`:""}
        </div>
      `;

      return `
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>${escapeHtml(title)} ‚Äî ${escapeHtml(proName)}</title>
<style>
  :root{
    --ink:#0b1220;
    --muted:#334155;
    --accent:#0ea5e9;
    --accent2:#16a34a;
    --paper:#ffffff;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; background:#e5e7eb; font-family: Arial, Helvetica, sans-serif; }
  .page{
    width: 210mm;
    min-height: 297mm;
    margin: 12mm auto;
    background: var(--paper);
    border-radius: 18px;
    border: 2px solid #0ea5e9;
    box-shadow: 0 10px 40px rgba(0,0,0,.18);
    overflow:hidden;
  }
  .inner{
    padding: 14mm 14mm 16mm 14mm;
  }
  header{
    border-bottom: 1px solid #cbd5e1;
    padding-bottom: 10px;
    margin-bottom: 10px;
  }
  header .t{
    display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
  }
  header h1{
    margin:0;
    font-size: 18px;
    letter-spacing:.3px;
    color: var(--ink);
  }
  header .pro{
    margin-top:4px;
    color: var(--muted);
    font-size: 12px;
    line-height:1.35;
  }
  .chip{
    display:inline-block;
    padding:6px 10px;
    border-radius: 999px;
    border: 1px solid #bae6fd;
    background:#eff6ff;
    color:#075985;
    font-size: 12px;
    white-space:nowrap;
  }
  .meta{
    display:grid;
    grid-template-columns: 1.2fr 1fr 1fr;
    gap:10px;
    padding:10px;
    border-radius: 14px;
    border: 1px solid #dbeafe;
    background:#f8fafc;
    margin: 10px 0 12px 0;
    font-size: 12px;
    color: #0f172a;
  }
  .block{
    border-radius: 14px;
    border: 1px solid #dbeafe;
    padding: 10px 12px;
    margin-bottom: 10px;
    break-inside: avoid;
    page-break-inside: avoid;
  }
  .block h3{
    margin:0 0 8px 0;
    font-size: 13px;
    color:#0f172a;
    letter-spacing:.3px;
    text-transform:uppercase;
  }
  p{ margin: 0 0 8px 0; color:#0f172a; font-size: 12.5px; line-height:1.55; }
  pre{
    margin:0;
    white-space:pre-wrap;
    word-wrap:break-word;
    font-family: Arial, Helvetica, sans-serif;
    font-size: 12.5px;
    line-height:1.6;
    color:#0f172a;
  }
  footer{
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #cbd5e1;
    color:#334155;
    font-size: 11.5px;
    line-height:1.4;
    display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
  }
  .sign{
    margin-top: 18mm;
    display:flex; justify-content:flex-end;
  }
  .line{
    width: 70mm;
    border-top: 1px solid #0f172a;
    padding-top: 6px;
    text-align:center;
    font-size: 11.5px;
    color:#0f172a;
  }
  @page{ size: A4; margin: 10mm; }
  @media print{
    body{ background: white; }
    .page{ margin:0; box-shadow:none; border-radius:0; border: 2px solid #0ea5e9; }
  }
</style>
</head>
<body>
  <div class="page">
    <div class="inner">
      <header>
        <div class="t">
          <div>
            <h1>${escapeHtml(title)}</h1>
            <div class="pro">
              <strong>${escapeHtml(proName)}</strong><br>
              ${escapeHtml(footer)}
            </div>
          </div>
          <div class="chip">${escapeHtml(city)}</div>
        </div>
      </header>

      ${patientLine}

      ${extraBody}

      ${odoBlock}

      <div class="sign">
        <div class="line">${escapeHtml(proName)}</div>
      </div>

      <footer>
        <div><strong>Contato:</strong> ${escapeHtml(contact)}</div>
        <div><strong>Gerado por:</strong> BTX Clinic (offline)</div>
      </footer>
    </div>
  </div>
</body>
</html>
      `;
    }

    function summarizeOdo(map){
      // produce simple summary: OK / warn / bad tooth lists
      const ok=[], warn=[], bad=[];
      for(const t of Object.keys(map||{})){
        const st = map[t];
        if(st===1) ok.push(t);
        if(st===2) warn.push(t);
        if(st===3) bad.push(t);
      }
      const parts=[];
      if(bad.length) parts.push(`Problema: ${bad.sort().join(", ")}`);
      if(warn.length) parts.push(`Aten√ß√£o: ${warn.sort().join(", ")}`);
      if(ok.length) parts.push(`OK: ${ok.sort().join(", ")}`);
      return parts.join(" ‚Ä¢ ");
    }

    /***********************
     *  Backup
     ***********************/
    function renderBackup(){
      // nothing dynamic needed
    }

    btnExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(DB, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `BTX_Clinic_Backup_${todayYMD()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Backup baixado ‚úÖ");
    });

    btnImport.addEventListener("click", async ()=>{
      const f = importFile.files?.[0];
      if(!f){
        toast("Selecione um arquivo <strong>JSON</strong>.");
        return;
      }
      try{
        const text = await f.text();
        const obj = JSON.parse(text);
        if(!obj || typeof obj!=="object") throw new Error("JSON inv√°lido");
        DB = obj;
        saveDB(false);
        initUI();
        toast("Restaurado ‚úÖ");
      }catch(e){
        alert("Falha ao restaurar: " + e.message);
      }
    });

    /***********************
     *  Settings
     ***********************/
    function renderSettings(){
      setProName.value = DB.settings.proName || "";
      setContact.value = DB.settings.contact || "";
      setCity.value = DB.settings.city || "";
      setFooter.value = DB.settings.footer || "";
      setPass.value = "";
    }

    btnSaveSettings.addEventListener("click", async ()=>{
      DB.settings.proName = setProName.value.trim() || defaultDB.settings.proName;
      DB.settings.contact = setContact.value.trim();
      DB.settings.city = setCity.value.trim();
      DB.settings.footer = setFooter.value.trim();

      if(setPass.value.trim()){
        DB.settings.passHash = await hashPass(setPass.value.trim());
      }
      saveDB(false);
      hydrateSideProfile();
      toast("Configura√ß√µes salvas ‚úÖ");
    });

    btnWipe.addEventListener("click", ()=>{
      const ok = confirm("APAGAR TUDO deste dispositivo? (irrevers√≠vel sem backup)");
      if(!ok) return;
      localStorage.removeItem(DB_KEY);
      loadDB();
      initUI();
      toast("Apagado ‚úÖ");
    });

    /***********************
     *  Nav
     ***********************/
    navButtons.forEach(b=>{
      b.addEventListener("click", ()=> setView(b.dataset.view));
    });

    /***********************
     *  Quick actions
     ***********************/
    quickNewAppt.addEventListener("click", ()=>{});
    quickNewPatient.addEventListener("click", ()=>{});

    /***********************
     *  Init
     ***********************/
    async function initUI(){
      await ensurePass();
      // apply photo on landing
      if(DB.proPhotoDataUrl){
        renderProPhoto();
      }else{
        hydrateSideProfile();
      }
      renderLandingKPIs();
      // set doc dates defaults
      docDate.value = todayYMD();
      attDate.value = todayYMD();
      orcDate.value = todayYMD();
      // set default agenda date
      agendaDate.value = todayYMD();
    }

    // App buttons
    quickNewAppt.addEventListener("click", ()=>{
      if(DB.patients.length===0){
        toast("Crie um <strong>paciente</strong> primeiro.");
        setView("patients");
        openNewPatientModal();
        return;
      }
      setView("agenda");
      openApptModal(null);
    });

    // patient shortcut in app
    quickNewPatient.addEventListener("click", ()=>{
      setView("patients");
      openNewPatientModal();
    });

    // agenda quick action from dashboard
    document.getElementById("quickNewAppt").addEventListener("click", ()=>{});

    // docs select patient sync
    docPatient.addEventListener("change", ()=>{
      // keep patient context
      currentPatientId = docPatient.value || null;
      odoPatient.value = currentPatientId || "";
    });

    // patients open from search results handled via window.__openPatient

    // initial load
    (async function boot(){
      loadDB();
      await initUI();
      renderLandingKPIs();
      renderDash();
      // initial landing photo fill
      if(DB.proPhotoDataUrl) renderProPhoto();
    })();
  </script>
</body>
</html>
